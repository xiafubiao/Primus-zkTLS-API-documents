<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Primus Network SDK Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 28px; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .content { padding: 30px; }
    
    .step {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    .step.active {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .step.completed {
      border-color: #4caf50;
      background: #f1f8e9;
    }
    .step.failed {
      border-color: #f44336;
      background: #ffebee;
    }
    
    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    .step.active .step-number {
      background: #667eea;
      color: white;
    }
    .step.completed .step-number {
      background: #4caf50;
      color: white;
    }
    .step.failed .step-number {
      background: #f44336;
      color: white;
    }
    
    .step-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .output {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    
    .config-section {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .config-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #856404;
    }
    .config-section input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ffc107;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .progress-bar {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 10px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” Primus Network SDK Demo</h1>
      <p>å®Œæ•´çš„ Attestation æµç¨‹æ¼”ç¤º</p>
    </div>
    
    <div class="content">
      <!-- é…ç½®åŒºåŸŸ -->
      <div class="config-section">
        <label>Template ID (åœ¨ dev.primuslabs.xyz åˆ›å»º)</label>
        <input type="text" id="templateId" placeholder="ä¾‹å¦‚ï¼š2e3160ae-8b1e-45e3-8c59-426366278b9d" value="">
        <small style="color: #856404; display: block; margin-top: 8px;">
          âš ï¸ è¯·å…ˆåœ¨ <a href="https://dev.primuslabs.xyz" target="_blank">Primus å¼€å‘è€…å¹³å°</a> åˆ›å»ºæ¨¡æ¿
        </small>
      </div>
      
      <!-- æ­¥éª¤ 1: è¿æ¥é’±åŒ… -->
      <div class="step" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <div class="step-title">è¿æ¥é’±åŒ…</div>
          <span class="status pending" id="status1">ç­‰å¾…å¼€å§‹</span>
        </div>
        <button onclick="connectWallet()" id="btn1">ğŸ”— è¿æ¥ MetaMask</button>
        <div class="output" id="output1" style="display: none;"></div>
      </div>
      
      <!-- æ­¥éª¤ 2: æäº¤ä»»åŠ¡ -->
      <div class="step" id="step2">
        <div class="step-header">
          <div class="step-number">2</div>
          <div class="step-title">æäº¤ä»»åŠ¡</div>
          <span class="status pending" id="status2">ç­‰å¾…ä¸Šä¸€æ­¥</span>
        </div>
        <button onclick="submitTask()" id="btn2" disabled>ğŸ“ æäº¤ Attestation ä»»åŠ¡</button>
        <div class="output" id="output2" style="display: none;"></div>
      </div>
      
      <!-- æ­¥éª¤ 3: æ‰§è¡Œ Attestation -->
      <div class="step" id="step3">
        <div class="step-header">
          <div class="step-number">3</div>
          <div class="step-title">æ‰§è¡Œ Attestation</div>
          <span class="status pending" id="status3">ç­‰å¾…ä¸Šä¸€æ­¥</span>
        </div>
        <button onclick="attestTask()" id="btn3" disabled>âœ… æ‰§è¡ŒéªŒè¯</button>
        <div class="output" id="output3" style="display: none;"></div>
      </div>
      
      <!-- æ­¥éª¤ 4: æŸ¥è¯¢ç»“æœ -->
      <div class="step" id="step4">
        <div class="step-header">
          <div class="step-number">4</div>
          <div class="step-title">æŸ¥è¯¢ç»“æœ</div>
          <span class="status pending" id="status4">ç­‰å¾…ä¸Šä¸€æ­¥</span>
        </div>
        <button onclick="pollResult()" id="btn4" disabled>ğŸ”„ è½®è¯¢ä»»åŠ¡ç»“æœ</button>
        <div class="output" id="output4" style="display: none;"></div>
      </div>
      
      <!-- è¿›åº¦æ¡ -->
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progressBar"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { PrimusNetwork } from "https://cdn.jsdelivr.net/npm/@primuslabs/network-js-sdk@latest/+esm";
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/+esm";

    const CHAIN_ID = 84532; // Base Sepolia
    
    let primusNetwork;
    let signer;
    let userAddress;
    let submitTaskResult;
    let attestResult;

    // æ›´æ–°çŠ¶æ€
    window.updateStatus = (step, status, message) => {
      const statusEl = document.getElementById(`status${step}`);
      statusEl.textContent = message;
      statusEl.className = `status ${status}`;
      
      const stepEl = document.getElementById(`step${step}`);
      stepEl.className = `step ${status === 'success' ? 'completed' : status === 'error' ? 'failed' : status === 'active' ? 'active' : ''}`;
      
      // æ›´æ–°è¿›åº¦æ¡
      const completedSteps = [1, 2, 3, 4].filter(i => {
        const el = document.getElementById(`status${i}`);
        return el && el.classList.contains('success');
      }).length;
      document.getElementById('progressBar').style.width = `${(completedSteps / 4) * 100}%`;
    };

    // æ˜¾ç¤ºè¾“å‡º
    window.showOutput = (step, text) => {
      const outputEl = document.getElementById(`output${step}`);
      outputEl.textContent = text;
      outputEl.style.display = 'block';
    };

    // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
    window.enableNext = (step) => {
      const btn = document.getElementById(`btn${step}`);
      if (btn) btn.disabled = false;
      
      const nextStatus = document.getElementById(`status${step}`);
      if (nextStatus) nextStatus.textContent = 'å‡†å¤‡å°±ç»ª';
    };

    // æ­¥éª¤ 1: è¿æ¥é’±åŒ…
    window.connectWallet = async () => {
      try {
        updateStatus(1, 'active', 'è¿æ¥ä¸­...');
        
        if (!window.ethereum) {
          throw new Error('MetaMask æœªå®‰è£…');
        }
        
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        // åˆ‡æ¢ç½‘ç»œ
        try {
          await provider.send("wallet_switchEthereumChain", [
            { chainId: "0x" + CHAIN_ID.toString(16) }
          ]);
        } catch (switchError) {
          if (switchError.code === 4902) {
            await provider.send("wallet_addEthereumChain", [{
              chainId: "0x" + CHAIN_ID.toString(16),
              chainName: "Base Sepolia",
              rpcUrls: ["https://sepolia.base.org"],
              nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
              blockExplorerUrls: ["https://sepolia.basescan.org"]
            }]);
          }
        }
        
        // åˆå§‹åŒ– SDK
        primusNetwork = new PrimusNetwork();
        await primusNetwork.init(signer, CHAIN_ID);
        
        updateStatus(1, 'success', 'å·²è¿æ¥');
        showOutput(1, `é’±åŒ…åœ°å€ï¼š${userAddress}\nç½‘ç»œï¼šBase Sepolia (84532)\nSDK: å·²åˆå§‹åŒ–`);
        enableNext(2);
        
      } catch (error) {
        updateStatus(1, 'error', 'å¤±è´¥');
        showOutput(1, `é”™è¯¯ï¼š${error.message}`);
      }
    };

    // æ­¥éª¤ 2: æäº¤ä»»åŠ¡
    window.submitTask = async () => {
      try {
        updateStatus(2, 'active', 'æäº¤ä¸­...');
        
        const templateId = document.getElementById('templateId').value;
        if (!templateId) {
          throw new Error('è¯·è¾“å…¥ Template ID');
        }
        
        submitTaskResult = await primusNetwork.submitTask({
          templateId,
          address: userAddress
        });
        
        updateStatus(2, 'success', 'å·²å®Œæˆ');
        showOutput(2, `ä»»åŠ¡ ID: ${submitTaskResult.taskId}\näº¤æ˜“å“ˆå¸Œï¼š${submitTaskResult.taskTxHash}\nAttestors: ${submitTaskResult.taskAttestors.join(', ')}\næäº¤æ—¶é—´ï¼š${new Date(submitTaskResult.submittedAt * 1000).toISOString()}`);
        enableNext(3);
        
      } catch (error) {
        updateStatus(2, 'error', 'å¤±è´¥');
        showOutput(2, `é”™è¯¯ï¼š${error.message}`);
      }
    };

    // æ­¥éª¤ 3: æ‰§è¡Œ Attestation
    window.attestTask = async () => {
      try {
        updateStatus(3, 'active', 'æ‰§è¡Œä¸­...');
        
        const templateId = document.getElementById('templateId').value;
        
        attestResult = await primusNetwork.attest({
          templateId,
          address: userAddress,
          ...submitTaskResult
        });
        
        updateStatus(3, 'success', 'å·²å®Œæˆ');
        showOutput(3, `Attestor: ${attestResult[0].attestor}\næŠ¥å‘Šå“ˆå¸Œï¼š${attestResult[0].reportTxHash}\nURL: ${attestResult[0].attestorUrl}\næ—¶é—´ï¼š${new Date(attestResult[0].attestationTime * 1000).toISOString()}`);
        enableNext(4);
        
      } catch (error) {
        updateStatus(3, 'error', 'å¤±è´¥');
        showOutput(3, `é”™è¯¯ï¼š${error.message}`);
      }
    };

    // æ­¥éª¤ 4: æŸ¥è¯¢ç»“æœ
    window.pollResult = async () => {
      try {
        updateStatus(4, 'active', 'è½®è¯¢ä¸­...');
        
        const taskResult = await primusNetwork.verifyAndPollTaskResult({
          taskId: attestResult[0].taskId,
          reportTxHash: attestResult[0].reportTxHash,
          intervalMs: 2000,
          timeoutMs: 120000
        });
        
        updateStatus(4, 'success', 'å·²å®Œæˆ');
        showOutput(4, `ä»»åŠ¡çŠ¶æ€ï¼šSUCCESS\nç»“æœï¼š${JSON.stringify(taskResult, null, 2)}`);
        
        alert('ğŸ‰ æ­å–œï¼å®Œæ•´æµç¨‹å·²å®Œæˆï¼');
        
      } catch (error) {
        updateStatus(4, 'error', 'å¤±è´¥');
        showOutput(4, `é”™è¯¯ï¼š${error.message}`);
      }
    };
  </script>
</body>
</html>
